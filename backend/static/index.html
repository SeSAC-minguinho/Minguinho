<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>음성 비서 프로그램</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.7/dist/bundle.min.js"></script>
</head>
<body>
<h1>STT / TTS</h1>
<div id="status">음성을 감지하고 이를 gpt4o-mini로 보낸 뒤 다시 음성으로 변환합니다.</div>
<button onclick="resetChat()">초기화</button>

<label for="tts">Select TTS:</label>
<select id="tts" onchange="updateVoices()">
    <option value="gtts">gTTS</option>
    <option value="openai">OpenAI</option>
    <option value="google">Google Cloud</option>
</select>

<label for="voice_name" id="voice_name_label">Select Voice Name:</label>
<select id="voice_name">
    <!-- Options will be populated dynamically -->
</select>

<script>
    const API_HOSTNAME = "{{ api_hostname }}";
    const ws = new WebSocket(`ws://${API_HOSTNAME}/ws`);

    async function setupVAD() {
        const myvad = await vad.MicVAD.new({
            onSpeechStart: () => {
                console.log("Speech start detected")
            },
            onSpeechEnd: (audio) => {
                sendAudioToServer(audio);
            }
        })
        myvad.start()
    }

    let audioQueue = [];
    let isPlaying = false;

    function playAudio(base64Audio) {
        audioQueue.push(base64Audio);
        if (!isPlaying) {
            playNextAudio();
        }
    }

    function playNextAudio() {
        if (audioQueue.length === 0) {
            isPlaying = false;
            return;
        }

        isPlaying = true;
        const base64Audio = audioQueue.shift();
        const audio = new Audio("data:audio/mp3;base64," + base64Audio);

        audio.onended = () => {
            playNextAudio(); // 현재 오디오가 끝나면 다음 오디오 재생
        };

        audio.play().catch(error => {
            console.error("Error playing audio:", error);
            playNextAudio(); // 에러 발생 시 다음 오디오로 넘어감
        });
    }

    function sendAudioToServer(audioSamples) {
        console.log("sendAudioToServer called");
        const blob = new Blob([audioSamples], {type: 'audio/wav'});
        console.log("Blob created:", blob);

        const formData = new FormData();
        const tts = document.getElementById('tts').value;
        formData.append('tts', tts);
        formData.append('voice_name', tts === 'gtts' ? 'placeholder' : document.getElementById('voice_name').value);
        formData.append('audio', blob, 'audio.wav');
        console.log("FormData created:", formData);


        fetch(`http://${API_HOSTNAME}/process_audio`, {method: 'POST', body: formData})
            .then(response => response.json())
            .then(data => {
                console.log("Server response:", data);
                if (data.success) {
                    ws.send("get_history");
                    updateChatDisplay(data.question, "User");
                    updateChatDisplay(data.response, "Assistant");
                    playAudio(data.audio_file);
                }
            })
            .catch(error => {
                console.error("Error sending audio to server:", error);
            });
    }

    function updateChatDisplay(message, sender) {
        const chatDiv = document.getElementById('chat');
        const messageDiv = document.createElement('div');
        const currentTime = new Date().toLocaleTimeString();
        messageDiv.textContent = `${sender} (${currentTime}): ${message}`;
        chatDiv.appendChild(messageDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight; // 스크롤을 최신 메시지로 이동
    }

    function resetChat() {
        fetch('http://${API_HOSTNAME}//reset', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('chat').innerHTML = '';
                }
            });
    }

    async function updateVoices() {
        const tts = document.getElementById('tts').value;
        const voiceSelect = document.getElementById('voice_name');
        const voiceLabel = document.getElementById('voice_name_label');
        voiceSelect.innerHTML = '';

        if (tts === 'gtts') {
            voiceSelect.style.display = 'none';
            voiceLabel.style.display = 'none';
        } else {
            voiceSelect.style.display = 'block';
            voiceLabel.style.display = 'block';
            if (tts === 'openai') {
                const voices = ["alloy", "echo", "fable", "onyx", "nova", "shimmer"];
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice;
                    option.textContent = voice;
                    voiceSelect.appendChild(option);
                });
            } else if (tts === 'google') {
                const voices = ["ko-KR-Standard-A", "ko-KR-Standard-B", "ko-KR-Standard-C", "ko-KR-Standard-D", "ko-KR-Wavenet-A", "ko-KR-Wavenet-B", "ko-KR-Wavenet-C", "ko-KR-Wavenet-D"];
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice;
                    option.textContent = voice;
                    voiceSelect.appendChild(option);
                });
            }
        }
    }

    ws.onmessage = function (event) {
        const chatHistory = JSON.parse(event.data);
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        chatHistory.forEach(item => {
            updateChatDisplay(item[2], item[0]); // item[2]는 메시지, item[0]은 발신자
        });
    };
    setupVAD();
    ws.onopen = () => ws.send("get_history");
    updateVoices();
</script>
<div id="chat"></div>
</body>
</html>